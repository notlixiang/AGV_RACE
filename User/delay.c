#include "delay.h"
#include "sys.h"
////////////////////////////////////////////////////////////////////////////////// 	 
//???'??OS,????????????l?????ucos?????????.
#if SYSTEM_SUPPORT_OS
#include "includes.h"					//???OS???'??	  
#endif
//////////////////////////////////////////////////////////////////////////////////  
//???????????'?ד?d???????????????????????????;
//ALIENTEK STM32F407??????
//'??SysTick?????????g????????????(???OS)
//????delay_us,delay_ms
//???????@ALIENTEK
//???????:www.openedv.com
//????????:2014/5/2
//????V1.3
//????????????????
//Copyright(C) ????????????????????? 2014-2024
//All rights reserved
//********************************************************************************
//??????
//V1.1 20140803 
//1,delay_us,??????????0???,???????????0,????????. 
//2,???ucosii??,delay_ms????,????OSLockNesting?????,?????????,??????????.
//V1.2 20150411  
//???OS?????,?????????OS(??????UCOSII??UCOSIII,??????????OS?????????)
//???:delay_osrunning/delay_ostickspersec/delay_osintnesting????????
//???:delay_osschedlock/delay_osschedunlock/delay_ostimedly????????
//V1.3 20150521
//????UCOSIII??????2??bug??
//delay_tickspersec?????delay_ostickspersec
//delay_intnesting?????delay_osintnesting
////////////////////////////////////////////////////////////////////////////////// 

static u8  fac_us=0;							//us?????????			   
static u16 fac_ms=0;							//ms?????????,??os??,?????????j?ms??
	
#if SYSTEM_SUPPORT_OS							//???SYSTEM_SUPPORT_OS??????,???????OS??(??????UCOS).
//??delay_us/delay_ms??????OS??????????????OS???l????????????
//??????3??????:
//    delay_osrunning:??????OS??j???????????,???????????'????????
//delay_ostickspersec:??????OS??????????,delay_init?????????????????'??systick
// delay_osintnesting:??????OS?????????,?????????????????,delay_ms'?רע????????????????
//?????3??????:
//  delay_osschedlock:????????OS???????,???????
//delay_osschedunlock:???????OS???????,???¿??????
//    delay_ostimedly:????OS???,???????????????.

//?????????UCOSII??UCOSIII?????,????OS,?????????????
//???UCOSII
#ifdef 	OS_CRITICAL_METHOD						//OS_CRITICAL_METHOD??????,???????UCOSII				
#define delay_osrunning		OSRunning			//OS?????????,0,??????;1,??????
#define delay_ostickspersec	OS_TICKS_PER_SEC	//OS??????,??????????
#define delay_osintnesting 	OSIntNesting		//?????????,???????????
#endif

//???UCOSIII
#ifdef 	CPU_CFG_CRITICAL_METHOD					//CPU_CFG_CRITICAL_METHOD??????,???????UCOSIII	
#define delay_osrunning		OSRunning			//OS?????????,0,??????;1,??????
#define delay_ostickspersec	OSCfg_TickRate_Hz	//OS??????,??????????
#define delay_osintnesting 	OSIntNestingCtr		//?????????,???????????
#endif


//us??????,??????????(??????us?????)
void delay_osschedlock(void)
{
#ifdef CPU_CFG_CRITICAL_METHOD   			//'??UCOSIII
	OS_ERR err; 
	OSSchedLock(&err);						//UCOSIII?k??,??????????????us???
#else										//????UCOSII
	OSSchedLock();							//UCOSII?k??,??????????????us???
#endif
}

//us??????,??????????
void delay_osschedunlock(void)
{	
#ifdef CPU_CFG_CRITICAL_METHOD   			//'??UCOSIII
	OS_ERR err; 
	OSSchedUnlock(&err);					//UCOSIII?k??,???????
#else										//????UCOSII
	OSSchedUnlock();						//UCOSII?k??,???????
#endif
}

//????OS???????????????
//ticks:????L?????
void delay_ostimedly(u32 ticks)
{
#ifdef CPU_CFG_CRITICAL_METHOD
	OS_ERR err; 
	OSTimeDly(ticks,OS_OPT_TIME_PERIODIC,&err);//UCOSIII???????????g?
#else
	OSTimeDly(ticks);						//UCOSII???
#endif 
}
 
//systick????????,'??OS??ץ?
void SysTick_Handler(void)
{	
	if(delay_osrunning==1)					//OS??'????,??????????j??????
	{
		OSIntEnter();						//???????
		OSTimeTick();       				//????ucos???????????               
		OSIntExit();       	 				//????????????????
	}
}
#endif
			   
//??'????????
//??'??OS?????,????????'??OS????????
//SYSTICK????????AHB????1/8
//SYSCLK:????????
void delay_init(u8 SYSCLK)
{
#if SYSTEM_SUPPORT_OS 						//?????????OS.
	u32 reload;
#endif
 	SysTick_CLKSourceConfig(SysTick_CLKSource_HCLK_Div8); 
	fac_us=SYSCLK/8;						//???????'??OS,fac_us?????'??
#if SYSTEM_SUPPORT_OS 						//?????????OS.
	reload=SYSCLK/8;						//????l??????? ????M	   
	reload*=1000000/delay_ostickspersec;	//????delay_ostickspersec????????
											//reload?24??J???,????:16777216,??168M??,???0.7989s????	
	fac_ms=1000/delay_ostickspersec;		//????OS???????????????	   
	SysTick->CTRL|=SysTick_CTRL_TICKINT_Msk;   	//????SYSTICK???
	SysTick->LOAD=reload; 					//1/delay_ostickspersec?????h??	
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk; 	//????SYSTICK    
#else
	fac_ms=(u16)fac_us*1000;				//??OS??,??????ms?????systick?????   
#endif
}								    

#if SYSTEM_SUPPORT_OS 						//?????????OS.
//???nus
//nus:??????us??.	
//nus:0~204522252(??????2^32/fac_us@fac_us=21)	    								   
void delay_us(u32 nus)
{		
	u32 ticks;
	u32 told,tnow,tcnt=0;
	u32 reload=SysTick->LOAD;				//LOAD???	    	 
	ticks=nus*fac_us; 						//????L????? 
	delay_osschedlock();					//???OS???????????us???
	told=SysTick->VAL;        				//???????l??????
	while(1)
	{
		tnow=SysTick->VAL;	
		if(tnow!=told)
		{	    
			if(tnow<told)tcnt+=told-tnow;	//???????h??SYSTICK??h??????l????????????.
			else tcnt+=reload-tnow+told;	    
			told=tnow;
			if(tcnt>=ticks)break;			//?????/????????????,?????.
		}  
	};
	delay_osschedunlock();					//???OS????											    
}  
//???nms
//nms:??????ms??
//nms:0~65535
void delay_ms(u16 nms)
{	
	if(delay_osrunning&&delay_osintnesting==0)//???OS?????????,????????????????(????????????????)	    
	{		 
		if(nms>=fac_ms)						//???????????OS????????????? 
		{ 
   			delay_ostimedly(nms/fac_ms);	//OS???
		}
		nms%=fac_ms;						//OS??????????פ????????,?????????????    
	}
	delay_us((u32)(nms*1000));				//?????????
}
#else  //????ucos?
//???nus
//nus???????us??.	
//???:nus???,???????798915us(??????2^24/fac_us@fac_us=21)
void delay_us(u32 nus)
{		
	u32 temp;	    	 
	SysTick->LOAD=nus*fac_us; 				//??????	  		 
	SysTick->VAL=0x00;        				//????????
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ; //??'???? 	 
	do
	{
		temp=SysTick->CTRL;
	}while((temp&0x01)&&!(temp&(1<<16)));	//????????   
	SysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk; //????????
	SysTick->VAL =0X00;       				//???????? 
}
//???nms
//???nms?k??
//SysTick->LOAD?24??J???,????,???????:
//nms<=0xffffff*8*1000/SYSCLK
//SYSCLK????Hz,nms????ms
//??168M??????,nms<=798ms 
void delay_xms(u16 nms)
{	 		  	  
	u32 temp;		   
	SysTick->LOAD=(u32)nms*fac_ms;			//??????(SysTick->LOAD?24bit)
	SysTick->VAL =0x00;           			//????????
	SysTick->CTRL|=SysTick_CTRL_ENABLE_Msk ;          //??'???? 
	do
	{
		temp=SysTick->CTRL;
	}while((temp&0x01)&&!(temp&(1<<16)));	//????????   
	SysTick->CTRL&=~SysTick_CTRL_ENABLE_Msk;       //????????
	SysTick->VAL =0X00;     		  		//????????	  	    
} 
//???nms 
//nms:0~65535
void delay_ms(u16 nms)
{	 	 
	u8 repeat=nms/540;						//??????540,?????????????????'??,
											//???????248M?????,delay_xms?????????541ms??????
	u16 remain=nms%540;
	while(repeat)
	{
		delay_xms(540);
		repeat--;
	}
	if(remain)delay_xms(remain);
} 
#endif
			 



































